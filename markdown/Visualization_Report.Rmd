---
title: "FAO Capture Report"
subtitle: "`r results$regionalized_subtitle`"
date : "`r format(Sys.time(), '%d %B, %Y')`"

output:
     pdf_document:
       fig_caption: yes
       toc: yes
       toc_depth: 2
header-includes:
       - \usepackage{fancyhdr}
---
\addtolength{\headheight}{1.0cm} 
\pagestyle{fancyplain} 
\rhead{\includegraphics[height=1cm]{D:/FAO-BLUECLOUD_04052020_11082020/02-R/04-Github/FaoCaptureDashboard/www/logo_BlueCloud.png}} 
\lhead{\includegraphics[height=1cm]{D:/FAO-BLUECLOUD_04052020_11082020/02-R/04-Github/FaoCaptureDashboard/www/FAO-logo.png}}
\chead{\includegraphics[height=1.4cm]{D:/FAO-BLUECLOUD_04052020_11082020/02-R/04-Github/FaoCaptureDashboard/www/INFOPESCA-logo.png}} 
\renewcommand{\headrulewidth}{0pt} 



## Introduction

The following report is a summary of long term  global fisheries data collect by the FAO.
`r md$identificationInfo[[1]]$abstract`
```{r echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE}
dataDesc<-if(is.null(query$par)){
glue('No selection was decided by the user, the content of this report will therefore relate to all the data available fo global geographic marine and inland fish catches from {min(as.numeric(param$select_year)} to {max(as.numeric(param$select_year))}.')
}else{
glue('A selection was decided by the user, the content of this report will therefore relate to regions : **{unique(param$select_region)*}**. The data include **{unique(param$select_f_area_type)*}** fish catches from **{min(as.numeric(param$select_year))}** to **{max(as.numeric(param$select_year))}**.',.transformer = collapse_transformer(sep = ", ", last = " and "))  
}

```
`r dataDesc`

## Summary

Number of regions | Number of countries | Number of different species | Temporal coverage | Total of captures
------------- | ------------- |------------- | -------------|------------- |
`r results$nb_region`|`r results$nb_flag` |`r results$nb_species` |`r paste0(results$min_year," - ",results$max_year)` |`r results$nb_capture` 

\newpage

## Visualization of results

### Area Chart

```{r area_fig, echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE , fig.width=7,fig.height=6,fig.cap="\\label{fig:area_fig}Sum of fish capture by year for each type of area"}

ggplot(results$fig_area,aes(x=as.integer(year),y=capture,fill=f_area_type))+
  #geom_line(stat="identity")+
  geom_bar(stat="identity")+
  labs(x="Year",y="Capture (Tons)")+
  theme_bw()+
  scale_x_continuous(breaks=seq(min(as.integer(results$fig_area$year)),max(as.integer(results$fig_area$year)),1))+
  theme(legend.title = element_blank(),
        legend.position = "bottom",
        axis.text.x=element_text(angle = 90))
tmp <- results$fig_area %>%
      group_by(year) %>% 
      summarise(capture = sum(capture))%>%
      ungroup()
tmp_min<-c(tmp[tmp$capture==min(tmp$capture),])
tmp_max<-c(tmp[tmp$capture==max(tmp$capture),])
tmp_mean<-mean(tmp$capture)

tmp_type<-cast(results$fig_area, year ~ f_area_type)
pourc<-round(mean(((tmp_type$marine-tmp_type$inland)/tmp_type$marine)*100),2)
test<-tmp_type$marine-tmp_type$inland
test1<-if(length(test[test>1])==length(test)){"always upper"
        }else if(length(test[test>1])>length(test[test<1])){"generally upper"
        }else if(length(test[test>1])==length(test[test<1])){"equal"
        }else if(length(test[test>1])<length(test[test<1])){"generally lower"
        }else if(length(test[test<1])==length(test)){"always lower"}else{"ERROR"}

```

Over the entire time series (*Figure \ref{fig:area_fig}*), the year recording the fewest captures is **`r tmp_min$year`** (with **`r tmp_min$capture`** tons) and the one recording the most captures is **`r tmp_max$year`** (with **`r tmp_max$capture`** tons).The average quantity of catches per year is **`r tmp_mean`** tons.
The quantity of fish caught is **`r test1`** in the marine area than inland area with in average **`r pourc`** % of capture caught in marine area.

### Species Chart

```{r echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE}
ggplot(results$fig_sp,aes(x=as.integer(year),y=capture,colour=species))+
  geom_line(stat="identity")+
  labs(x="Year",y="Capture (Tons)")+
  theme_bw()+
  theme(legend.title = element_blank(),
        legend.position = "bottom")
```

### Flag Chart

```{r echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE}
ggplot(results$fig_flag,aes(x=as.integer(year),y=capture,colour=flag))+
  geom_line(stat="identity")+
  labs(x="Year",y="Capture (Tons)")+
  theme_bw()+
  theme(legend.title = element_blank(),
        legend.position = "bottom")
```

### Flag Chart

```{r echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE}
ggplot(results$fig_flag,aes(x=as.integer(year),y=capture,colour=flag))+
  geom_line(stat="identity")+
  labs(x="Year",y="Capture (Tons)")+
  theme_bw()+
  theme(legend.title = element_blank(),
        legend.position = "bottom")
```

\newpage

## Metadata Ressources
### Download and links for data
```{r data_link, echo=FALSE, results='asis'}
f<-as.data.frame(do.call("rbind", lapply(md$distributionInfo$transferOptions[[1]]$onLine, function(x){data.frame(link = x$linkage$value, name = x$name, description = x$description)})))
f$text<-f$text<-glue('**{f$description}** [link]({f$link})')

for (i in 1:nrow(f)) {
    cat("-", f[i,]$text, '\n')
}
```

### Download and links for metadata
- **Metadata - XML Format :** [xml link](https://geonetwork-sdi-lab.d4science.org/geonetwork/srv/eng/xml.metadata.get?uuid=fao_capture_flag_dbquery_advanced_multiyear)
- **Metadata - Geonetwork Catalog :** [geonetwork catalog link](https://geonetwork-sdi-lab.d4science.org/geonetwork/srv/eng/catalog.search#/metadata/fao_capture_flag_dbquery_advanced_multiyear)

### About this ressource

- **Date of `r md$identificationInfo[[1]]$citation$date[[2]]$dateType$value` : ** `r md$identificationInfo[[1]]$citation$date[[2]]$date `

- **Date of edition : ** `r gsub(md$identificationInfo[[1]]$citation$editionDate,pattern ='T',replacement = ' ')`

- **Temporal coverage : ** `r md$identificationInfo[[1]]$extent`

- **Lineage :** `r md$dataQualityInfo[[1]]$lineage$statement`


### Contact for the ressource

```{r contact_info, echo=FALSE, results='asis'}
f<-as.data.frame((do.call("rbind", lapply(md$identificationInfo[[1]]$pointOfContact, function(x){data.frame(individualName = x$individualName, organisationName = x$organisationName, electronicMailAddress = x$contactInfo$address$electronicMailAddress,role = x$role$value)}))))

for (i in 1:nrow(f)) {
    cat("-", as.character(f[i,]$role), '\n',
        "**",as.character(f[i,]$individualName),"(",as.character(f[i,]$organisationName),")**",'\n',
        as.character(f[i,]$electronicMailAddress),'\n'
        )
}

```

### Contact for the report and application

\newpage

## Access to data with R

******

```{r echo=FALSE,comment=FALSE,warning=FALSE,message=FALSE}
rtext<-glue('#packages

     if(!require(ows4R)){{
     install.packages("ows4R")
     require(ows4R)
     }}
     
     if(!require(sp)){{
       install.packages("sp")
       require(sp)
     }}   
     
#Dataset PID

pid <- "{query$pid}"

layer <- "{query$layer}"

#Connect to OGC CSW Catalogue to get METADATA

CSW <- CSWClient$new(

       url = "{query$csw_server}",
       
       serviceVersion = "{query$csw_version}",
       
       logger = "INFO"
       
       )

#Get metadata for dataset

md <- CSW$getRecordById(pid, outputSchema = "http://www.isotc211.org/2005/gmd")

fc <- CSW$getRecordById(paste0(pid,"_dsd"), outputSchema = "http://www.isotc211.org/2005/gfc")

#Connect to OGC WFS to get DATA

WFS <- WFSClient$new(

        url = "{query$wfs_server}",
        
        serviceVersion = "{query$wfs_version}",
        
        logger = "INFO"
        
        )

#Get feature type for dataset "{query$layer}"

ft <- WFS$capabilities$findFeatureTypeByName(layer)

#Get data features for dataset "{query$layer}"

data.sf <- ft$getFeatures(viewparams = "{query$par}")

data.sp <- as(data.sf, "Spatial")

')
```
`r rtext`

******


